<div id="related">
  <div class="section-title big">RELATED PRODUCTS</div>
  <div class="main">
    {%- assign current_product_id = product.id -%}
    {%- assign current_tags = product.tags -%}

    {%- assign related_products = '' -%}
    {%- assign prioritized_products = '' -%}
    {%- assign other_products = '' -%}

    <!-- Obtener productos relacionados de las mismas colecciones -->
    {%- for collection in product.collections -%}
        {%- assign collection_products = collection.products | where: "available", true -%}
        
        <!-- Filtrar el producto actual y agregar los productos de esta colección -->
        {%- for p in collection_products -%}
            {%- if p.id != current_product_id -%} <!-- Excluir el producto actual -->
                {%- assign shared_tags = p.tags | intersection: current_tags -%}
                {%- if shared_tags.size > 0 -%}
                    {%- assign prioritized_products = prioritized_products | append: p.id | append: ',' -%}
                {%- else -%}
                    {%- assign other_products = other_products | append: p.id | append: ',' -%}
                {%- endif -%}
            {%- endif -%}
        {%- endfor -%}
    {%- endfor -%}

    <!-- Combinar productos priorizados con los demás -->
    {%- assign prioritized_products = prioritized_products | split: ',' | uniq -%}
    {%- assign other_products = other_products | split: ',' | uniq -%}
    {%- assign final_products = prioritized_products | concat: other_products -%}

    <!-- Mostrar solo 4 productos -->
    {%- assign count = 0 -%}
    {%- for product_id in final_products -%}
        {%- assign related = all_products[product_id] -%}
        {%- if related and count < 4 -%}
            {% include 'product-body' with related %}
            {%- assign count = count | plus: 1 -%}
        {%- endif -%}
    {%- endfor -%}

    {%- if count == 0 -%}
        <p>No related products available.</p>
    {%- endif -%}
  </div>
</div>

<style>
  .section-title.big {
    margin-bottom: 10px;
    margin-top: 60px;
    line-height: var(--lh);
    font-size: clamp(var(--big), 1.5vw, 2rem);
  }
</style>